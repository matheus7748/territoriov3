<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa do Territ√≥rio</title>
    <style>
        /* 1. Transi√ß√£o e Acessibilidade */
        * {
            transition: all 0.3s ease;
            box-sizing: border-box; 
        }
        input:focus, button:focus, .tab-btn:focus, #menuToggle:focus, #closeMenuBtn:focus, #observacoesTextarea:focus {
            outline: 2px solid #4a90e2; 
            outline-offset: 2px;
        }
        
        /* 2. Cursor Padr√£o */
        .quadra button, .logout, .reset-btn, #menuToggle, #closeMenuBtn, #sidebarBairrosList button {
            cursor: pointer;
        }
        
        /* Estilos Base */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            gap: 20px;
            padding: 20px;
            flex-direction: row;
        }

        /* --- CSS SIDEBAR --- */
        #menuToggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1100;
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #menuToggle:hover {
            background: #3a7acb;
        }

        #sidebarMenu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: #f8f8f8;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            z-index: 2000;
            padding: 20px;
            padding-top: 50px;
            overflow-y: auto;
            transition: left 0.3s ease;
        }

        #sidebarMenu.open {
            left: 0;
        }
        
        #sidebarMenu h3 {
            margin-top: 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        #closeMenuBtn {
            background: #d9534f;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            position: absolute;
            top: 10px;
            right: 10px;
            font-weight: bold;
        }

        #sidebarBairrosList button {
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            padding: 12px 10px;
            margin: 5px 0;
            font-size: 16px;
            color: #333;
            border-radius: 5px;
            outline: none;
        }
        #sidebarBairrosList button.active {
            background: #4a90e2;
            color: white;
            font-weight: bold;
        }
        #sidebarBairrosList button:hover:not(.active) {
            background: #e0e0e0;
        }
        /* --- FIM CSS SIDEBAR --- */


        .mapa {
            flex: 2;
            min-width: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            padding: 10px;
            position: relative;
            margin-left: 50px;
        }

        .mapa img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .painel {
            flex: 1;
            min-width: 350px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            overflow-y: auto;
            max-height: 96vh;
        }
        
        .painel h2 { text-align: center; margin-bottom: 20px; }
        
        /* Estilos para o novo campo de Observa√ß√µes */
        #observacoesContainer {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #observacoesTextarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
        }
        
        /* Estilos de quadras mantidos */
        .quadra { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 8px; background-color: #eee; }
        .quadra span { font-weight: bold; }
        .quadra button { border: none; padding: 6px 10px; border-radius: 6px; color: white; font-weight: bold; min-width: 120px; }
        .quadra button:hover { filter: brightness(110%); transform: scale(1.02); }

        .btn-nao { background-color: red; }
        .btn-meio { background-color: orange; }
        .btn-sim { background-color: green; }
        
        /* Bot√µes de A√ß√£o Final */
        .logout { display: block; width: 100%; background-color: #444; color: white; border: none; padding: 10px; border-radius: 8px; margin-top: 20px; }
        .logout:hover { background-color: #222; }
        
        .reset-btn {
            display: block; 
            width: 100%; 
            background-color: #d9534f;
            color: white; 
            border: none; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 10px; 
            font-weight: bold;
        }
        .reset-btn:hover { background-color: #c9302c; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilo para a Notifica√ß√£o de Salvamento */
        #salvarFeedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: green;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        #salvarFeedback.show {
            opacity: 1;
            visibility: visible;
        }

        /* üì± MEDIA QUERY: AJUSTES PARA CELULAR (Telas menores que 768px) */
        @media (max-width: 768px) {
            body {
                flex-direction: column; 
                height: auto; 
                padding: 10px;
            }

            .mapa {
                min-width: 100%; 
                margin-bottom: 15px;
                margin-left: 0;
                padding-top: 50px;
            }

            .mapa img {
                 max-height: 40vh; 
                 object-fit: contain;
            }
            
            #menuToggle {
                top: 10px;
                left: 10px;
            }
            
            .painel {
                max-height: 80vh;
            }
        }
    </style>
</head>
<body>

    <button id="menuToggle" title="Abrir Menu de Bairros">...</button>
    
    <div id="sidebarMenu">
        <button id="closeMenuBtn">X</button>
        <h3>Selecione o Bairro</h3>
        <div id="sidebarBairrosList">
            </div>
    </div>

    <div class="mapa">
        <img id="mapaImg" src="mapa.jpg" alt="Mapa do Territ√≥rio Geral"> 
    </div>

    <div class="painel">
        <h2 id="bairroTitulo">Selecione um Bairro</h2>
        
        <div id="observacoesContainer" style="display: none;">
            <h4>Observa√ß√µes do Bairro</h4>
            <textarea id="observacoesTextarea" placeholder="Digite aqui anota√ß√µes importantes sobre o bairro..."></textarea>
        </div>
        
        <div id="conteudoBairros">
             </div>
        
        <button class="reset-btn" id="resetBtn" style="display: none;">Limpar Marca√ß√µes</button>
        <button class="logout" id="logoutBtn">Sair</button>
    </div>
    
    <div id="salvarFeedback">Salvo! (Instant√¢neo)</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // SUAS CONFIGURA√á√ïES FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCjSNz59SgzJwzqndzOJO4GRqHZ3-6abGM",
            authDomain: "login-territorios.firebaseapp.com",
            projectId: "login-territorios",
            storageBucket: "login-territorios.firebasestorage.app",
            messagingSenderId: "495689013315",
            appId: "1:495689013315:web:c8b22bbf1fe9ad99779cf6",
            measurementId: "G-P4YG93BTN6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        const auth = getAuth(app);    

        // üèòÔ∏è Defini√ß√£o dos Bairros e Quadras
        const bairros = {
            "Comercial (Centro)": 15,
            "Comercial (Vila S√£o Jorge)": 19,
            "Vila Brasil": 21, 
            "Vila Iti": 13,
            "Cinquenten√°rio A": 4,
            "Cinquenten√°rio B": 6,
            "Vila Mendes": 8,
            "Vila Luso A": 11,
            "Vila Luso B": 10,
            "Vila Rainho": 11,
            "S√£o Domingos": 13,
            "Jardim Planaltina": 19,
            "S√£o Bento": 8,
            "Parque Alvorada A": 21,
            "Parque Alvorada B": 15,
            "Santa M√¥nica": 19,
            "Sumar√©": 17,
            "Souza Reis": 18,
            "Itapu√£": 11,
            "Itapura": 4,
            "Pq. dos Resed√°s": 1,
            "Vista Bonita A": 14,
            "Vista Bonita B": 5,
            "Vista Bonita C": 11,
            "Vista Bonita D": 11
        };

        // üñºÔ∏è MAPA DE NOMES DE ARQUIVO (Ajustado para a extens√£o .jpg)
        const mapaNomesArquivos = {
            "ComercialCentro": "comercial(centro).jpg",
            "ComercialVilaS√£oJorge": "comercial(vilas√£ojorge).jpg",
            "VilaBrasil": "vilabrasil.jpg",
            "VilaIti": "vilaiti.jpg",
            "Cinquenten√°rioA": "cinquentenarioA.jpg",
            "Cinquenten√°rioB": "cinquentenarioB.jpg",
            "VilaMendes": "vilamendes.jpg",
            "VilaLusoA": "vilalusoA.jpg",
            "VilaLusoB": "vilalusoB.jpg",
            "VilaRainho": "vilarainho.jpg",
            "S√£oDomingos": "saodomingos.jpg",
            "JardimPlanaltina": "jardimplanaltina.jpg",
            "S√£oBento": "saobento.jpg",
            "ParqueAlvoradaA": "pqalvoradaA.jpg",
            "ParqueAlvoradaB": "pqalvoradaB.jpg",
            "SantaM√¥nica": "santam√¥nica.jpg",
            "Sumar√©": "sumare.jpg",
            "SouzaReis": "souzareis.jpg",
            "Itapu√£": "itapua.jpg",
            "Itapura": "itapura.jpg",
            "PqdosResed√°s": "pqdosresedas.jpg",
            "VistaBonitaA": "vistabonitaA.jpg",
            "VistaBonitaB": "vistabonitaB.jpg",
            "VistaBonitaC": "vistabonitaC.jpg",
            "VistaBonitaD": "vistabonitaD.jpg"
        };


        let quadrasPorBairro = {}; 
        
        const mapaImgElement = document.getElementById("mapaImg");
        const salvarFeedback = document.getElementById("salvarFeedback");
        const resetBtn = document.getElementById("resetBtn");
        const bairroTitulo = document.getElementById("bairroTitulo");
        const menuToggle = document.getElementById("menuToggle");
        const sidebarMenu = document.getElementById("sidebarMenu");
        const closeMenuBtn = document.getElementById("closeMenuBtn");
        const sidebarBairrosList = document.getElementById("sidebarBairrosList");
        const conteudoBairros = document.getElementById("conteudoBairros");
        const observacoesContainer = document.getElementById("observacoesContainer");
        const observacoesTextarea = document.getElementById("observacoesTextarea");
        
        const urlMapaGeral = mapaImgElement.src; 
        let bairroAtivoID = null;
        let bairroAtivoNome = null;
        let isContentLoaded = false; 

        // ------------------ L√ìGICA DO MENU LATERAL (SIDEBAR) ------------------
        menuToggle.addEventListener("click", () => {
            sidebarMenu.classList.add("open");
        });

        closeMenuBtn.addEventListener("click", () => {
            sidebarMenu.classList.remove("open");
        });

        // ------------------ FUN√á√ïES AUXILIARES ------------------

        // üîÑ FUN√á√ÉO DE FEEDBACK DE SALVAMENTO
        let feedbackTimeout;
        function mostrarFeedbackSalvo() {
            clearTimeout(feedbackTimeout);
            salvarFeedback.classList.add("show");
            feedbackTimeout = setTimeout(() => {
                salvarFeedback.classList.remove("show");
            }, 2000); 
        }
        
        // üñºÔ∏è FUN√á√ÉO DE ATUALIZA√á√ÉO DA IMAGEM GERAL DO BAIRRO
        function atualizarImagemGeral(bairroID) {
            const filename = mapaNomesArquivos[bairroID];
            if (filename) {
                // CORRIGIDO PARA O NOVO REPOSIT√ìRIO: /territoriov3/
                mapaImgElement.src = `/territoriov3/bairro_maps/${filename}`; 
            } else {
                mapaImgElement.src = urlMapaGeral; 
            }
        }
        
        // üßπ FUN√á√ÉO DE LIMPEZA DE MARCA√á√ïES (RESET)
        async function limparMarcacoes() {
            if (!bairroAtivoID || !bairroAtivoNome) return;

            if (!confirm(`Tem certeza que deseja limpar TODAS as marca√ß√µes do bairro ${bairroAtivoNome}? Essa a√ß√£o √© irrevers√≠vel no Firebase.`)) {
                return;
            }

            const numQuadras = bairros[bairroAtivoNome];
            const updates = {};
            
            for (let i = 1; i <= numQuadras; i++) {
                updates[`quadra${i}/status`] = "N√£o feita";
            }

            try {
                const bairroRef = ref(db, `territorios/${bairroAtivoID}`);
                await update(bairroRef, updates);
                mostrarFeedbackSalvo(); 
                alert(`Marca√ß√µes do bairro ${bairroAtivoNome} limpas com sucesso!`);
            } catch (error) {
                console.error("Erro ao limpar marca√ß√µes:", error);
                alert("Erro ao limpar marca√ß√µes. Verifique sua conex√£o e permiss√µes.");
            }
        }
        
        resetBtn.addEventListener('click', limparMarcacoes);
        
        // üìù FUN√á√ÉO DE SALVAMENTO DE OBSERVA√á√ïES
        let saveObsTimeout;
        observacoesTextarea.addEventListener('input', () => {
            if (!bairroAtivoID) return;
            
            clearTimeout(saveObsTimeout);
            
            saveObsTimeout = setTimeout(() => {
                const obsRef = ref(db, `territorios/${bairroAtivoID}/observacoes`);
                set(obsRef, observacoesTextarea.value)
                    .then(() => mostrarFeedbackSalvo());
            }, 1000); 
        });

        // ------------------ FUN√á√ÉO DE TROCA DE BAIRRO (A√á√ÉO PRINCIPAL DO MENU) ------------------
        function setBairroAtivo(bairroID, nomeBairro) {
            bairroAtivoID = bairroID;
            bairroAtivoNome = nomeBairro;
            
            // 1. Atualiza o T√≠tulo, o Bot√£o de Reset e a Imagem
            bairroTitulo.textContent = nomeBairro;
            resetBtn.textContent = `Limpar Marca√ß√µes (${nomeBairro})`;
            resetBtn.style.display = 'block';
            atualizarImagemGeral(bairroID); 
            observacoesContainer.style.display = 'block'; 

            // 2. Esconde todos os conte√∫dos e mostra o ativo
            document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
            document.getElementById(`content-${bairroID}`).classList.add("active");

            // 3. Atualiza o estado "ativo" no menu
            document.querySelectorAll("#sidebarBairrosList button").forEach(btn => btn.classList.remove("active"));
            document.querySelector(`#sidebarBairrosList button[data-bairro="${bairroID}"]`).classList.add("active");

            // 4. Carrega as observa√ß√µes 
            const obsRef = ref(db, `territorios/${bairroID}/observacoes`);
            onValue(obsRef, (snapshot) => {
                const obs = snapshot.val() || "";
                if (bairroID === bairroAtivoID) {
                    observacoesTextarea.value = obs;
                }
            }, { onlyOnce: true });

            // 5. Fecha o menu
            sidebarMenu.classList.remove("open");
        }


        // ------------------ FUN√á√ÉO PRINCIPAL DE CARREGAMENTO ------------------

        function carregarPainel() {
            if (isContentLoaded) return;
            isContentLoaded = true;

            let primeiroBairroID = null;
            let primeiroBairroNome = null;
            
            // 1. Cria a estrutura de quadras no painel e bot√µes na sidebar
            Object.keys(bairros).forEach((nomeBairro, index) => {
                const numQuadras = bairros[nomeBairro];
                const bairroID = nomeBairro.replace(/[^a-zA-Z0-9]/g, '');

                // A. Cria o bot√£o na SIDEBAR
                const sidebarBtn = document.createElement("button");
                sidebarBtn.textContent = nomeBairro;
                sidebarBtn.dataset.bairro = bairroID;
                sidebarBtn.dataset.nomeCompleto = nomeBairro;
                sidebarBairrosList.appendChild(sidebarBtn);
                
                sidebarBtn.addEventListener("click", () => {
                    setBairroAtivo(bairroID, nomeBairro);
                });


                // B. Cria o container de CONTE√öDO (quadras)
                const tabContent = document.createElement("div");
                tabContent.classList.add("tab-content");
                tabContent.id = `content-${bairroID}`;
                conteudoBairros.appendChild(tabContent);
                
                quadrasPorBairro[nomeBairro] = {}; 

                // C. Cria as quadras
                for (let i = 1; i <= numQuadras; i++) {
                    const div = document.createElement("div");
                    div.classList.add("quadra");

                    const nome = document.createElement("span");
                    let nomeQuadra = `Quadra ${i}`;
                    
                    /* ‚ö†Ô∏è PERSONALIZA√á√ÉO DE NOME: Parque Alvorada A (CDHU/CEU) ‚ö†Ô∏è */
                    if (nomeBairro === "Parque Alvorada A") {
                        if (i === 20) {
                            nomeQuadra = "CDHU";
                        } else if (i === 21) {
                            nomeQuadra = "CEU";
                        }
                    }
                    nome.textContent = nomeQuadra;

                    const btn = document.createElement("button");
                    btn.textContent = "N√£o feita";
                    btn.classList.add("btn-nao");
                    
                    div.appendChild(nome);
                    div.appendChild(btn);
                    tabContent.appendChild(div);
                    
                    quadrasPorBairro[nomeBairro][i] = btn; 

                    // Evento de Clique e Salvamento
                    btn.addEventListener("click", () => {
                        let novoStatus;
                        
                        if (btn.textContent === "N√£o feita") {
                            novoStatus = "Em andamento";
                        } else if (btn.textContent === "Em andamento") {
                            novoStatus = "Conclu√≠da";
                        } else {
                            novoStatus = "N√£o feita";
                        }
                        
                        const quadraRef = ref(db, `territorios/${bairroID}/quadra${i}`);
                        set(quadraRef, { status: novoStatus })
                            .then(() => {
                                mostrarFeedbackSalvo();
                            });
                    });
                }

                if (index === 0) {
                    primeiroBairroID = bairroID;
                    primeiroBairroNome = nomeBairro;
                }
            });
            
            // 2. Ativa o primeiro bairro criado por padr√£o
            if (primeiroBairroID) {
                setBairroAtivo(primeiroBairroID, primeiroBairroNome);
            }


            // 3. üîÑ Configura o Listener em tempo real para TODAS as quadras
            const geralRef = ref(db, "territorios");
            onValue(geralRef, (snapshot) => {
                const dadosGerais = snapshot.val() || {};
                
                Object.keys(bairros).forEach(nomeBairro => {
                    const bairroID = nomeBairro.replace(/[^a-zA-Z0-9]/g, '');
                    const dadosBairro = dadosGerais[bairroID] || {};
                    
                    for (let i = 1; i <= bairros[nomeBairro]; i++) {
                        const status = dadosBairro[`quadra${i}`]?.status || "N√£o feita"; 
                        const btn = quadrasPorBairro[nomeBairro][i];
                        
                        if (btn) {
                            if (status === "N√£o feita") {
                                btn.textContent = "N√£o feita";
                                btn.className = "btn-nao";
                            } else if (status === "Em andamento") {
                                btn.textContent = "Em andamento";
                                btn.className = "btn-meio";
                            } else if (status === "Conclu√≠da") {
                                btn.textContent = "Conclu√≠da";
                                btn.className = "btn-sim";
                            }
                        }
                    }
                });
            });
        }


        // üîí VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
        onAuthStateChanged(auth, (user) => {
            if (user) {
                carregarPainel();
            } else {
                // CORRIGIDO PARA O NOVO REPOSIT√ìRIO: /territoriov3/
                window.location.href = "/territoriov3/index.html"; 
            }
        });

        // üö™ Logout
        document.getElementById("logoutBtn").addEventListener("click", async () => {
          await signOut(auth);
        });

    </script>

</body>
</html>