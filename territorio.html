<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa do Território</title>
    <style>
        * { transition: all 0.3s ease; box-sizing: border-box; }
        input:focus, button:focus, .tab-btn:focus, #menuToggle:focus, #closeMenuBtn:focus, #observacoesTextarea:focus {
            outline: 2px solid #4a90e2; outline-offset: 2px;
        }
        body { margin: 0; font-family: Arial, sans-serif; background-color: #f0f0f0;
            display: flex; justify-content: center; align-items: flex-start; height: 100vh;
            gap: 20px; padding: 20px; flex-direction: row;
        }
        #menuToggle { position: fixed; top: 15px; left: 15px; z-index: 1100; background: #4a90e2;
            color: white; border: none; padding: 10px 15px; font-size: 24px; font-weight: bold;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); cursor: pointer;
        }
        #sidebarMenu { position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
            background: #f8f8f8; box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 2000;
            padding: 20px; padding-top: 50px; overflow-y: auto; transition: left 0.3s ease;
        }
        #sidebarMenu.open { left: 0; }
        #sidebarMenu h3 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
        #closeMenuBtn { background: #d9534f; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; position: absolute; top: 10px; right: 10px; font-weight: bold; cursor: pointer;
        }
        #sidebarBairrosList button { display: block; width: 100%; text-align: left; background: none; border: none;
            padding: 12px 10px; margin: 5px 0; font-size: 16px; color: #333; border-radius: 5px; outline: none;
            cursor: pointer;
        }
        #sidebarBairrosList button.active { background: #4a90e2; color: white; font-weight: bold; }
        #sidebarBairrosList button:hover:not(.active) { background: #e0e0e0; }
        .mapa { flex: 2; min-width: 400px; display: flex; justify-content: center; align-items: center;
            background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
            padding: 10px; position: relative; margin-left: 50px;
        }
        .mapa img { max-width: 100%; height: auto; border-radius: 10px; }
        .painel { flex: 1; min-width: 350px; background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2); overflow-y: auto; max-height: 96vh;
        }
        
        /* === NOVO: Container para Título + Botão === */
        .titulo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Espaço que o h2 tinha */
        }
        .painel h2 {
            text-align: center;
            margin-bottom: 0; /* Remove a margem do h2 */
        }
        .toggle-btn {
            background: #6c757d; /* Cinza neutro */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px; /* Botão pequeno */
            font-size: 12px; /* Fonte pequena */
            cursor: pointer;
            display: none; /* Começa escondido */
        }
        .toggle-btn:hover {
            background: #5a6268;
        }
        /* === FIM NOVO === */

        #datasContainer {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: none; /* Datas começam escondidas */
        }
        #datasContainer label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        #datasContainer input[type="date"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        #observacoesContainer { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd;
            border-radius: 8px; background-color: #f9f9f9; display: none;
        }
        #observacoesTextarea { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ccc;
            border-radius: 4px; resize: vertical; font-size: 14px;
        }
        .quadra { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px;
            border-radius: 8px; background-color: #eee; }
        .quadra span { font-weight: bold; margin-right: 10px; }
        .logout, .reset-btn { display: block; width: 100%; color: white; border: none; padding: 10px; border-radius: 8px;
            margin-top: 10px; font-weight: bold; cursor: pointer;
        }
        .logout { background-color: #444; } .logout:hover { background-color: #222; }
        .reset-btn { background-color: #d9534f; display: none; } /* Começa escondido */
        .reset-btn:hover { background-color: #c9302c; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        #salvarFeedback { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: green; color: white; padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        #salvarFeedback.show { opacity: 1; visibility: visible; }
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; padding: 10px; }
            .mapa { min-width: 100%; margin-bottom: 15px; margin-left: 0; padding-top: 50px; }
            .mapa img { max-height: 40vh; object-fit: contain; }
            #menuToggle { top: 10px; left: 10px; }
            .painel { max-height: 80vh; }
            .titulo-container { flex-wrap: wrap; } /* Ajuste para mobile */
            .toggle-btn { margin-top: 5px; width: 100%; }
        }
    </style>
</head>
<body>

    <button id="menuToggle" title="Abrir Menu de Bairros">...</button>
    
    <div id="sidebarMenu">
        <button id="closeMenuBtn">X</button>
        <h3>Selecione o Bairro</h3>
        <div id="sidebarBairrosList"></div>
    </div>

    <div class="mapa">
        <img id="mapaImg" src="mapa.jpg" alt="Mapa do Território Geral"> 
    </div>

    <div class="painel">
        <div class="titulo-container">
            <h2 id="bairroTitulo">Selecione um Bairro</h2>
            <button id="toggleDatasBtn" class="toggle-btn">Ver Datas</button>
        </div>
        
        <div id="datasContainer">
            <label for="dataInicio">Início do território:</label>
            <input type="date" id="dataInicio">
            <label for="dataFim">Fim do território:</label>
            <input type="date" id="dataFim">
        </div>
        
        <div id="observacoesContainer">
            <h4>Observações do Bairro</h4>
            <textarea id="observacoesTextarea" placeholder="Digite aqui anotações importantes sobre o bairro..."></textarea>
        </div>
        
        <div id="conteudoBairros"></div>
        
        <button class="reset-btn" id="resetBtn">Reiniciar marcações</button>
        <button class="logout" id="logoutBtn">Sair</button>
    </div>
    
    <div id="salvarFeedback">Salvo! (Instantâneo)</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCjSNz59SgzJwzqndzOJO4GRqHZ3-6abGM",
            authDomain: "login-territorios.firebaseapp.com",
            projectId: "login-territorios",
            storageBucket: "login-territorios.firebasestorage.app",
            messagingSenderId: "495689013315",
            appId: "1:495689013315:web:c8b22bbf1fe9ad99779cf6",
            measurementId: "G-P4YG93BTN6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        const auth = getAuth(app);    

        const bairros = {
            "Comercial (Centro)": 15, "Comercial (Vila São Jorge)": 19, "Vila Brasil": 21,
            "Vila Iti": 13, "Cinquentenário A": 4, "Cinquentenário B": 6, "Vila Mendes": 8,
            "Vila Luso A": 11, "Vila Luso B": 10, "Vila Rainho": 11, "São Domingos": 13,
            "Jardim Planaltina": 19, "São Bento": 8, "Parque Alvorada A": 21, "Parque Alvorada B": 15,
            "Santa Mônica": 19, "Sumaré": 17, "Souza Reis": 18, "Itapuã": 11, "Itapura": 4,
            "Pq. dos Resedás": 1, "Vista Bonita A": 14, "Vista Bonita B": 5, "Vista Bonita C": 11,
            "Vista Bonita D": 11
        };

        const mapaNomesArquivos = {
            "ComercialCentro": "comercialcentro.jpeg",
            "ComercialVilaSoJorge": "comercialvilasaojorge.jpeg",
            "VilaBrasil": "vilabrasil.jpeg",
            "VilaIti": "vilaiti.jpeg",
            "CinquentenrioA": "cinquentenarioA.jpeg",
            "CinquentenrioB": "cinquentenarioB.jpeg",
            "VilaMendes": "vilamendes.jpeg",
            "VilaLusoA": "vilalusoA.jpeg",
            "VilaLusoB": "vilalusoB.jpeg",
            "VilaRainho": "vilarainho.jpeg",
            "SoDomingos": "saodomingos.jpeg",
            "JardimPlanaltina": "jardimplanaltina.jpeg",
            "SoBento": "saobento.jpeg",
            "ParqueAlvoradaA": "pqalvoradaA.jpeg",
            "ParqueAlvoradaB": "pqalvoradaB.jpeg",
            "SantaMnica": "santamonica.jpeg",
            "Sumar": "sumare.jpeg",
            "SouzaReis": "souzareis.jpeg",
            "Itapu": "itapua.jpeg",
            "Itapura": "itapura.jpeg",
            "PqdosReseds": "pqdosresedas.jpeg",
            "VistaBonitaA": "vistabonitaA.jpeg",
            "VistaBonitaB": "vistabonitaB.jpeg",
            "VistaBonitaC": "vistabonitaC.jpeg",
            "VistaBonitaD": "vistabonitaD.jpeg"
        };

        let quadrasPorBairro = {};
        const mapaImgElement = document.getElementById("mapaImg");
        const salvarFeedback = document.getElementById("salvarFeedback");
        const resetBtn = document.getElementById("resetBtn");
        const bairroTitulo = document.getElementById("bairroTitulo");
        const menuToggle = document.getElementById("menuToggle");
        const sidebarMenu = document.getElementById("sidebarMenu");
        const closeMenuBtn = document.getElementById("closeMenuBtn");
        const sidebarBairrosList = document.getElementById("sidebarBairrosList");
        const conteudoBairros = document.getElementById("conteudoBairros");
        const observacoesContainer = document.getElementById("observacoesContainer");
        const observacoesTextarea = document.getElementById("observacoesTextarea");
        
        const datasContainer = document.getElementById("datasContainer");
        const dataInicioInput = document.getElementById("dataInicio");
        const dataFimInput = document.getElementById("dataFim");
        
        // === NOVO: Variável para o botão de toggle ===
        const toggleDatasBtn = document.getElementById("toggleDatasBtn");

        const urlMapaGeral = mapaImgElement.src; 
        let bairroAtivoID = null;
        let bairroAtivoNome = null;
        let isContentLoaded = false; 

        menuToggle.addEventListener("click", ()=>sidebarMenu.classList.add("open"));
        closeMenuBtn.addEventListener("click", ()=>sidebarMenu.classList.remove("open"));

        let feedbackTimeout;
        function mostrarFeedbackSalvo(){
            clearTimeout(feedbackTimeout);
            salvarFeedback.classList.add("show");
            feedbackTimeout=setTimeout(()=>salvarFeedback.classList.remove("show"),2000);
        }

        function atualizarImagemGeral(bairroID){
            const filename = mapaNomesArquivos[bairroID];
            mapaImgElement.src = filename ? `/territoriov3/bairro_maps/${filename}` : urlMapaGeral;
        }

        // === FUNÇÃO 'REINICIAR' ATUALIZADA ===
        async function limparMarcacoes(){
            if(!bairroAtivoID || !bairroAtivoNome) return;
            if(!confirm(`Tem certeza que deseja REINICIAR TODAS as marcações e datas do bairro ${bairroAtivoNome}?`)) return;
            
            const numQuadras = bairros[bairroAtivoNome];
            const updates = {};
            
            // Limpa as quadras
            for(let i=1;i<=numQuadras;i++) updates[`quadra${i}/status`] = "Não feita";
            
            // Limpa as datas
            updates['datas/inicio'] = "";
            updates['datas/fim'] = "";

            try{
                // Envia tudo para o Firebase de uma vez
                await update(ref(db, `territorios/${bairroAtivoID}`), updates);
                
                // Atualiza a interface (limpa os campos de data)
                dataInicioInput.value = "";
                dataFimInput.value = "";

                mostrarFeedbackSalvo();
                alert(`Marcações do bairro ${bairroAtivoNome} reiniciadas com sucesso!`);
            }catch(e){console.error(e); alert("Erro ao reiniciar marcações.");}
        }
        resetBtn.addEventListener("click", limparMarcacoes);
        // === FIM DA ATUALIZAÇÃO ===

        let saveObsTimeout;
        observacoesTextarea.addEventListener('input', ()=>{
            if(!bairroAtivoID) return;
            clearTimeout(saveObsTimeout);
            saveObsTimeout = setTimeout(()=>{
                set(ref(db, `territorios/${bairroAtivoID}/observacoes`), observacoesTextarea.value).then(mostrarFeedbackSalvo);
            },1000);
        });

        // Salvar datas (continua igual)
        function salvarDatas() {
            if (!bairroAtivoID) return;
            const datasRef = ref(db, `territorios/${bairroAtivoID}/datas`);
            const data = { inicio: dataInicioInput.value, fim: dataFimInput.value };
            set(datasRef, data).then(mostrarFeedbackSalvo);
        }
        dataInicioInput.addEventListener('change', salvarDatas);
        dataFimInput.addEventListener('change', salvarDatas);

        // === NOVO: Event listener para o botão de toggle ===
        toggleDatasBtn.addEventListener('click', () => {
            if (datasContainer.style.display === 'block') {
                datasContainer.style.display = 'none';
                toggleDatasBtn.textContent = 'Ver Datas';
            } else {
                datasContainer.style.display = 'block';
                toggleDatasBtn.textContent = 'Ocultar Datas';
            }
        });
        // === FIM DO NOVO LISTENER ===

        function setBairroAtivo(bairroID,nomeBairro){
            bairroAtivoID = bairroID;
            bairroAtivoNome = nomeBairro;
            bairroTitulo.textContent = nomeBairro;
            
            // Renomeia o botão de reiniciar
            resetBtn.textContent = `Reiniciar marcações (${nomeBairro})`;
            resetBtn.style.display='block';
            
            atualizarImagemGeral(bairroID);
            
            // Mostra os containers (Observações e botão de Datas)
            observacoesContainer.style.display='block';
            toggleDatasBtn.style.display = 'block'; // Mostra o botão "Ver Datas"
            
            // Garante que as datas estão escondidas ao trocar de bairro
            datasContainer.style.display = 'none';
            toggleDatasBtn.textContent = 'Ver Datas';

            document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
            document.getElementById(`content-${bairroID}`).classList.add("active");
            document.querySelectorAll("#sidebarBairrosList button").forEach(b=>b.classList.remove("active"));
            document.querySelector(`#sidebarBairrosList button[data-bairro="${bairroID}"]`).classList.add("active");

            // Carrega as observações
            onValue(ref(db, `territorios/${bairroID}/observacoes`), snap=>{
                if(bairroID===bairroAtivoID) observacoesTextarea.value = snap.val()||"";
            }, {onlyOnce:true});
            
            // Carrega as datas
            onValue(ref(db, `territorios/${bairroID}/datas`), snap=>{
                if(bairroID===bairroAtivoID) {
                    const datas = snap.val() || {};
                    dataInicioInput.value = datas.inicio || "";
                    dataFimInput.value = datas.fim || "";
                }
            }, {onlyOnce:true});

            sidebarMenu.classList.remove("open");
        }

        function carregarPainel(){
            if(isContentLoaded) return;
            isContentLoaded=true;

            let primeiroBairroID=null, primeiroBairroNome=null;

            Object.keys(bairros).forEach((nomeBairro,index)=>{
                const bairroID = nomeBairro.replace(/[^a-zA-Z0-9]/g,'');
                
                // Botão Sidebar
                const sidebarBtn = document.createElement("button");
                sidebarBtn.textContent = nomeBairro;
                sidebarBtn.dataset.bairro = bairroID;
                sidebarBairrosList.appendChild(sidebarBtn);
                sidebarBtn.addEventListener("click", ()=>setBairroAtivo(bairroID,nomeBairro));

                // Tab Content
                const tabContent = document.createElement("div");
                tabContent.classList.add("tab-content");
                tabContent.id = `content-${bairroID}`;
                conteudoBairros.appendChild(tabContent);

                quadrasPorBairro[nomeBairro]={};
                const numQuadras = bairros[nomeBairro];
                
                for(let i=1;i<=numQuadras;i++){
                    const div = document.createElement("div");
                    div.classList.add("quadra");

                    const nome = document.createElement("span");
                    let nomeQuadra = `Quadra ${i}`;
                    if(nomeBairro==="Parque Alvorada A"){
                        if(i===20) nomeQuadra="CDHU";
                        else if(i===21) nomeQuadra="CEU";
                    }
                    nome.textContent = nomeQuadra;

                    const statusBtn = document.createElement("button");
                    statusBtn.style.flex="1"; statusBtn.style.height="40px"; statusBtn.style.border="none"; statusBtn.style.borderRadius="8px";
                    statusBtn.style.fontWeight="bold"; statusBtn.style.color="white"; statusBtn.style.cursor="pointer";

                    const estados=["Não feita","Em andamento","Finalizada"];
                    const cores={ "Não feita":"red","Em andamento":"orange","Finalizada":"green" };
                    let statusAtual="Não feita";
                    function atualizarBotao(status){
                        statusBtn.textContent=status;
                        statusBtn.style.backgroundColor=cores[status];
                    }
                    atualizarBotao(statusAtual);

                    statusBtn.addEventListener("click", ()=>{
                        const idx=estados.indexOf(statusAtual);
                        statusAtual=estados[(idx+1)%estados.length];
                        atualizarBotao(statusAtual);
                        update(ref(db, `territorios/${bairroID}/quadra${i}`), {status:statusAtual}).then(mostrarFeedbackSalvo);
                    });

                    const quadraRef = ref(db, `territorios/${bairroID}/quadra${i}`);
                    onValue(quadraRef, snap=>{
                        const val = snap.val()?.status || "Não feita";
                        statusAtual=val;
                        atualizarBotao(statusAtual);
                        quadrasPorBairro[nomeBairro][i] = statusBtn;
                    });

                    div.append(nome,statusBtn);
                    tabContent.appendChild(div);
                }

                if(index===0){ primeiroBairroID=bairroID; primeiroBairroNome=nomeBairro; }
            });

            if(primeiroBairroID) setBairroAtivo(primeiroBairroID,primeiroBairroNome);
        }

        onAuthStateChanged(auth,user=>{
            if(user) carregarPainel();
            // Corrigido para apontar para o index.html (página de login)
            else window.location.href="/territoriov3/index.html"; 
        });

        document.getElementById("logoutBtn").addEventListener("click",()=>{
            // Corrigido para apontar para o index.html (página de login)
            signOut(auth).then(()=>window.location.href="/territoriov3/index.html");
        });

    </script>
</body>
</html>
    </script>
</body>
</html>

